<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYLA Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body">

<div class="admin-container">

    <div id="login-screen" class="admin-card login-card">
        <h1>AYLA Admin</h1>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Вход в панель управления</p>
        <input type="password" id="admin-pass" placeholder="Пароль (12345)" class="admin-input big-input" onkeyup="if(event.key === 'Enter') checkPassword()">
        <button onclick="checkPassword()" class="admin-btn primary-btn full-width">Войти</button>
        <p id="login-error" style="color: var(--danger); margin-top: 10px; display: none;">Неверный пароль</p>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="admin-header">
            <h2>Панель управления</h2>
            <button onclick="logout()" class="admin-btn text-btn">Выйти</button>
        </header>

        <section class="admin-section">
            <h3 class="section-title" style="text-align: left; padding-left: 0;">Категории</h3>

            <div class="admin-card" style="margin-bottom: 20px;">
                <input type="text" id="cat-name-ru" placeholder="Название (RU)" class="admin-input">
                <input type="text" id="cat-name-en" placeholder="Name (EN)" class="admin-input">
                <input type="text" id="cat-image" placeholder="URL картинки" class="admin-input">
                <button onclick="addCategory()" class="admin-btn primary-btn full-width">Добавить категорию</button>
            </div>

            <div id="admin-categories-list" class="admin-list"></div>
        </section>

        <section id="items-section" class="admin-section hidden">
            <h3 class="section-title" style="text-align: left; padding-left: 0;">Товары: <span id="current-cat-name"></span></h3>
            <button onclick="closeItems()" class="admin-btn text-btn" style="margin-bottom: 15px;">← Назад к категориям</button>

            <div class="admin-card" style="margin-bottom: 20px;">
                <input type="text" id="item-name-ru" placeholder="Название (RU)" class="admin-input">
                <input type="text" id="item-name-en" placeholder="Name (EN)" class="admin-input">
                <input type="text" id="item-desc-ru" placeholder="Описание (RU)" class="admin-input">
                <input type="text" id="item-desc-en" placeholder="Description (EN)" class="admin-input">
                <input type="number" id="item-price" placeholder="Цена (сом)" class="admin-input">
                <input type="text" id="item-image" placeholder="URL картинки" class="admin-input">
                <button onclick="addItem()" class="admin-btn primary-btn full-width">Добавить товар</button>
            </div>

            <div id="admin-items-list" class="admin-list"></div>
        </section>
    </div>
</div>

<script>
    const API_URL = '/api';
    let currentCatId = null;

    function checkPassword() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === '12345') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCategories();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    function logout() {
        location.reload();
    }

    // === CATEGORIES ===
    async function loadCategories() {
        const res = await fetch(`${API_URL}/categories`);
        const cats = await res.json();
        const list = document.getElementById('admin-categories-list');
        list.innerHTML = '';

        cats.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'admin-list-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; cursor:pointer; flex:1;" onclick="openItems(${cat.id}, '${cat.name_ru}')">
                    <img src="${cat.image || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="item-details">
                        <span class="ru">${cat.name_ru}</span>
                        <span class="en">${cat.name_en}</span>
                    </div>
                </div>
                <button onclick="deleteCategory(${cat.id})" class="admin-btn danger-btn sm-btn">X</button>
            `;
            list.appendChild(div);
        });
    }

    async function addCategory() {
        const name_ru = document.getElementById('cat-name-ru').value;
        const name_en = document.getElementById('cat-name-en').value;
        const image = document.getElementById('cat-image').value;

        if(!name_ru) return alert('Введите название!');

        await fetch(`${API_URL}/admin/categories`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name_ru, name_en, image})
        });

        document.getElementById('cat-name-ru').value = '';
        document.getElementById('cat-name-en').value = '';
        document.getElementById('cat-image').value = '';
        loadCategories();
    }

    async function deleteCategory(id) {
        if(confirm('Удалить категорию и все товары в ней?')) {
            await fetch(`${API_URL}/admin/categories/${id}`, {method: 'DELETE'});
            loadCategories();
        }
    }

    // === ITEMS ===
    function openItems(catId, catName) {
        currentCatId = catId;
        document.getElementById('current-cat-name').textContent = catName;
        document.getElementById('items-section').classList.remove('hidden');
        // Скрываем список категорий для фокуса на товарах
        document.getElementById('admin-categories-list').parentElement.classList.add('hidden');
        loadItems(catId);
    }

    function closeItems() {
        document.getElementById('items-section').classList.add('hidden');
        document.getElementById('admin-categories-list').parentElement.classList.remove('hidden');
        currentCatId = null;
    }

    async function loadItems(catId) {
        const res = await fetch(`${API_URL}/items?category_id=${catId}`);
        const items = await res.json();
        const list = document.getElementById('admin-items-list');
        list.innerHTML = '';

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'admin-list-item';
            div.innerHTML = `
                <img src="${item.image || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
                <div class="item-details">
                    <span class="ru">${item.name_ru}</span>
                    <span class="en">${item.name_en}</span>
                    <span class="price">${item.price} с</span>
                </div>
                <button onclick="deleteItem(${item.id})" class="admin-btn danger-btn sm-btn">X</button>
            `;
            list.appendChild(div);
        });
    }

    async function addItem() {
        if(!currentCatId) return;

        const name_ru = document.getElementById('item-name-ru').value;
        const name_en = document.getElementById('item-name-en').value;
        const description_ru = document.getElementById('item-desc-ru').value;
        const description_en = document.getElementById('item-desc-en').value;
        const price = document.getElementById('item-price').value;
        const image = document.getElementById('item-image').value;

        if(!name_ru || !price) return alert('Нужно название и цена!');

        await fetch(`${API_URL}/admin/items`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category_id: currentCatId,
                name_ru, name_en, description_ru, description_en, price, image
            })
        });

        // Очистка
        document.getElementById('item-name-ru').value = '';
        document.getElementById('item-price').value = '';
        document.getElementById('item-image').value = '';

        loadItems(currentCatId);
    }

    async function deleteItem(id) {
        if(confirm('Удалить товар?')) {
            await fetch(`${API_URL}/admin/items/${id}`, {method: 'DELETE'});
            loadItems(currentCatId);
        }
    }
</script>

</body>
</html>